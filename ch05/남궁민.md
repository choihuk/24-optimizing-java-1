---
marp: true
---

# Gradle í™˜ê²½ì—ì„œ JMH ì„¸íŒ…í•˜ê³  í”¼ë³´ë‚˜ì¹˜ ì„±ëŠ¥ ì¸¡ì •í•˜ê¸°

---

## Gradle ì„¤ì •í•˜ê¸°

build.gradle.kts

```gradle
plugins {
  id("me.champeau.jmh") version "0.7.2"
}
```

```gradle
dependencies {
  jmh("org.openjdk.jmh:jmh-core:1.36")
  jmh("org.openjdk.jmh:jmh-generator-annprocess:1.36")
  jmhAnnotationProcessor("org.openjdk.jmh:jmh-generator-annprocess:1.36")
}
```

```gradle
jmh {
  fork = 1
  warmupIterations = 1
  iterations = 1
}
```

---

## í”„ë¡œì íŠ¸ êµ¬ì¡°

![jmh-dir](https://github.com/Learning-Is-Vital-In-Development/24-optimizing-java-1/assets/75058239/8df20132-aada-4946-af9d-535e4c12d0a3)

- src/jmh í•˜ìœ„ ë””ë ‰í† ë¦¬ì— ë²¤ì¹˜ë§ˆí¬ ì½”ë“œ ì‘ì„±

---

## ì‹¤í–‰ ë°©ë²•

```bash
./gradlew jmh
```

í˜¹ì€ IDEì—ì„œ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ì‹¤í–‰

<br>

ğŸ‘‰ ì†ŒìŠ¤ ì½”ë“œ í™•ì¸í•˜ê¸°

---

```java
@Fork(warmups = 2, value = 2)
@Warmup(iterations = 2, time = 2, timeUnit = TimeUnit.SECONDS)
@BenchmarkMode(value = Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
@Measurement(iterations = 2, time = 2, timeUnit = TimeUnit.SECONDS)
public class FibonacciBenchmark
```

- `@Fork`: ì¸¡ì • ë°˜ë³µ íšŸìˆ˜
- `@Warmup`: ì¸¡ì • ì „ì— JVMì„ ë¯¸ë¦¬ warmupí•˜ëŠ” íšŸìˆ˜ì™€ ì‹œê°„
- `@BenchmarkMode`: ì¸¡ì • ë°©ì‹
  - `Mode.AverageTime`: í‰ê·  ì‹œê°„ ì¸¡ì •
  - `Mode.Throughput`: ì´ˆë‹¹ ì²˜ë¦¬ëŸ‰ ì¸¡ì •
  - `Mode.SampleTime`: ì¸¡ì • ëŒ€ìƒ ë©”ì„œë“œì˜ ì‹¤í–‰ ì‹œê°„ ì¸¡ì • (ìµœëŒ€/ìµœì†Œ ì‹œê°„ ë“±)
  - `Mode.SingleShotTime`: ì¸¡ì • ëŒ€ìƒ ë©”ì„œë“œì˜ ë‹¨ì¼ ì‹¤í–‰ ì‹œê°„ ì¸¡ì • (Cold Start)
  - `Mode.All`: ëª¨ë“  ë°©ì‹ìœ¼ë¡œ ì¸¡ì •
- `@OutputTimeUnit`: ì¸¡ì • ê²°ê³¼ë¥¼ ì¶œë ¥í•  ì‹œê°„ ë‹¨ìœ„
- `@Measurement`: ì¸¡ì • ë°˜ë³µ íšŸìˆ˜

---

ê·¸ ë°–ì˜ ì–´ë…¸í…Œì´ì…˜ë“¤

- `@State`: Argument ìƒíƒœ ì§€ì •
  - `@State(Scope.Thread)`: ì“°ë ˆë“œë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - `@State(Scope.Benchmark)`: ë²¤ì¹˜ë§ˆí¬ë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - `@State(Scope.Group)`: ê°™ì€ ê·¸ë£¹ì— ì†í•œ ë²¤ì¹˜ë§ˆí¬ë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- `@Threads`: ì“°ë ˆë“œ ê°œìˆ˜ ì§€ì •
- `@Setup`: ì¸¡ì • ì „ì— ì‹¤í–‰í•  ë©”ì„œë“œ ì§€ì •
- `@TearDown`: ì¸¡ì • í›„ì— ì‹¤í–‰í•  ë©”ì„œë“œ ì§€ì •
- `@Benchmark`: ì¸¡ì • ëŒ€ìƒ ë©”ì„œë“œë¡œ ì§€ì •

---

í”¼ë³´ë‚˜ì¹˜ ë²¤ì¹˜ë§ˆí¬ ìˆ˜í–‰ ê²°ê³¼

```txt
Benchmark                                              Mode  Cnt           Score          Error   Units
FibonacciBenchmark.bottomUp                            avgt    3          50.900 Â±        0.649   ns/op
FibonacciBenchmark.bottomUp:Â·gc.alloc.rate             avgt    3        3746.501 Â±       45.707  MB/sec
FibonacciBenchmark.bottomUp:Â·gc.alloc.rate.norm        avgt    3         200.000 Â±        0.001    B/op
FibonacciBenchmark.bottomUp:Â·gc.count                  avgt    3          18.000                 counts
FibonacciBenchmark.bottomUp:Â·gc.time                   avgt    3          17.000                     ms
FibonacciBenchmark.bottomUp:Â·stack                     avgt                  NaN                    ---
FibonacciBenchmark.memoization                         avgt    3          99.987 Â±        2.166   ns/op
FibonacciBenchmark.memoization:Â·gc.alloc.rate          avgt    3        1907.262 Â±       41.570  MB/sec
FibonacciBenchmark.memoization:Â·gc.alloc.rate.norm     avgt    3         200.000 Â±        0.001    B/op
FibonacciBenchmark.memoization:Â·gc.count               avgt    3          10.000                 counts
FibonacciBenchmark.memoization:Â·gc.time                avgt    3          11.000                     ms
FibonacciBenchmark.memoization:Â·stack                  avgt                  NaN                    ---
FibonacciBenchmark.naiveRecursive                      avgt    3  2239616569.333 Â± 42666708.402   ns/op
FibonacciBenchmark.naiveRecursive:Â·gc.alloc.rate       avgt    3          â‰ˆ 10â»â´                 MB/sec
FibonacciBenchmark.naiveRecursive:Â·gc.alloc.rate.norm  avgt    3         408.000 Â±        0.001    B/op
FibonacciBenchmark.naiveRecursive:Â·gc.count            avgt    3             â‰ˆ 0                 counts
FibonacciBenchmark.naiveRecursive:Â·stack               avgt                  NaN                    ---
FibonacciBenchmark.stream                              avgt    3         634.686 Â±       18.670   ns/op
FibonacciBenchmark.stream:Â·gc.alloc.rate               avgt    3        2872.475 Â±       83.524  MB/sec
FibonacciBenchmark.stream:Â·gc.alloc.rate.norm          avgt    3        1912.000 Â±        0.001    B/op
FibonacciBenchmark.stream:Â·gc.count                    avgt    3          14.000                 counts
FibonacciBenchmark.stream:Â·gc.time                     avgt    3          15.000                     ms
FibonacciBenchmark.stream:Â·stack                       avgt                  NaN                    ---
FibonacciBenchmark.tailRecursive                       avgt    3          26.291 Â±        0.311   ns/op
FibonacciBenchmark.tailRecursive:Â·gc.alloc.rate        avgt    3          â‰ˆ 10â»â´                 MB/sec
FibonacciBenchmark.tailRecursive:Â·gc.alloc.rate.norm   avgt    3          â‰ˆ 10â»âµ                   B/op
FibonacciBenchmark.tailRecursive:Â·gc.count             avgt    3             â‰ˆ 0                 counts
FibonacciBenchmark.tailRecursive:Â·stack                avgt                  NaN                    ---
```

---

GCProfiler, StackProfiler ê´€ë ¨ ì •ë³´ë“¤

- `gc.alloc.rate`: GC ì´ë²¤íŠ¸ë¡œ ì¸í•œ ê°ì²´ í• ë‹¹ ë¹„ìœ¨
- `gc.alloc.rate.norm`: `gc.alloc.rate`ë¥¼ ì‹¤í–‰ ì‹œê°„ìœ¼ë¡œ ë‚˜ëˆˆ ê²ƒ
- `gc.count`: GC ì´ë²¤íŠ¸ íšŸìˆ˜
- `gc.time`: GC ì´ë²¤íŠ¸ì— ì†Œìš”ëœ ì‹œê°„
- `stack`: ë©”ì†Œë“œ í˜¸ì¶œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤

---

```java
@Fork(warmups = 2, value = 2)
@Warmup(iterations = 2, time = 2, timeUnit = TimeUnit.SECONDS)
@BenchmarkMode(value = Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
@Measurement(iterations = 2, time = 2, timeUnit = TimeUnit.SECONDS)
public class FibonacciBenchmark {
    public int fibNaiveRecursive(int x) {
        return (x == 1 || x == 2) ? 1 : fibNaiveRecursive(x - 1) + fibNaiveRecursive(x - 2);
    }

    public int fibTailRecursive(int x) {
        return fibTailRec(x, 0, 1);
    }

    private int fibTailRec(int n, int a, int b) {
        if (n == 0) return a;
        if (n == 1) return b;
        return fibTailRec(n - 1, b, a + b);
    }

    public int fibMemoization(int x, int[] mem) {
        if (mem[x] != 0) return mem[x];
        if (x == 1 || x == 2)  return 1;
        int n = fibMemoization(x - 1, mem) + fibMemoization(x - 2, mem);
        mem[x] = n;
        return n;
    }

    public int fibBottomUp(int x) {
        if (x == 1 || x == 2) return 1;
        int[] memory = new int[x + 1];
        memory[1] = 1;
        memory[2] = 1;
        for (int i = 3; i <= x; i++) memory[i] = memory[i - 1] + memory[i - 2];
        return memory[x];
    }

    public int fibStream(int n) {
        return Objects.requireNonNull(Stream.iterate(new Integer[]{0, 1}, s -> new Integer[]{s[1], s[0] + s[1]})
                .limit(n)
                .reduce((x, y) -> y).orElse(null))[1];
    }

    @Benchmark
    public void naiveRecursive() {
        fibNaiveRecursive(45);
    }

    @Benchmark
    public void tailRecursive(){
        fibTailRecursive(45);
    }

    @Benchmark
    public void memoization() {
        fibMemoization(45, new int[45 + 1]);
    }

    @Benchmark
    public void bottomUp() {
        fibBottomUp(45);
    }

    @Benchmark
    public void stream() {
        fibStream(45);
    }

    public static void main(String[] args) throws RunnerException, IOException {
        Options opt = new OptionsBuilder()
                .include(FibonacciBenchmark.class.getSimpleName())
                .warmupIterations(10)
                .measurementIterations(3).forks(1)
                .jvmArgs("-server", "-Xms2G", "-Xmx2G")
                .addProfiler(GCProfiler.class)
                .addProfiler(StackProfiler.class)
                .build();
        new Runner(opt).run();
    }
}
```
